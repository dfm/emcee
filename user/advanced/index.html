
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Advanced Patterns &mdash; emcee 1.1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="emcee 1.1.0 documentation" href="../../" />
    <link rel="next" title="FAQ" href="../faq/" />
    <link rel="prev" title="Quickstart" href="../quickstart/" />
     
    
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

    <script type="text/javascript" src="//use.typekit.com/phg8fgl.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>

    <link href="http://fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700|Alegreya+SC:400,700" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="../../_static/favicon.png">


  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../faq/" title="FAQ"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../quickstart/" title="Quickstart"
             accesskey="P">previous</a> |</li>
        <li><a href="../../">emcee 1.1.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <span class="target" id="module-emcee"><span id="advanced"></span></span><div class="section" id="advanced-patterns">
<h1>Advanced Patterns<a class="headerlink" href="#advanced-patterns" title="Permalink to this headline">¶</a></h1>
<p><tt class="docutils literal"><span class="pre">emcee</span></tt> is generally pretty simple but it has a few key features that make
the usage easier in real problems. Here are a few examples of things that
you might find useful.</p>
<div class="section" id="incrementally-saving-progress">
<h2>Incrementally saving progress<a class="headerlink" href="#incrementally-saving-progress" title="Permalink to this headline">¶</a></h2>
<p>It is often useful to incrementally save the state of the chain to a file.
This makes it easier to monitor the chain&#8217;s progress and it makes things a
little less disastrous if your code/computer crashes somewhere in the middle
of an expensive MCMC run. If you just want to append the walker positions to
the end of a file, you could do something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;chain.dat&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">sampler</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pos0</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">storechain</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;chain.dat&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">position</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;{0:4d} {1:s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="multiprocessing">
<h2>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this headline">¶</a></h2>
<p>In principle, running <tt class="docutils literal"><span class="pre">emcee</span></tt> in parallel is as simple instantiating an
<a class="reference internal" href="../../api/#emcee.EnsembleSampler" title="emcee.EnsembleSampler"><tt class="xref py py-class docutils literal"><span class="pre">EnsembleSampler</span></tt></a> object with the <tt class="docutils literal"><span class="pre">threads</span></tt> argument set to an
integer greater than 1:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">lnprobfn</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<p>In practice, the parallelization is implemented using the built in Python
<a class="reference external" href="http://docs.python.org/library/multiprocessing.html">multiprocessing</a>
module. With this comes a few constraints. In particular, both <tt class="docutils literal"><span class="pre">lnprobfn</span></tt>
and <tt class="docutils literal"><span class="pre">args</span></tt> must be <a class="reference external" href="http://docs.python.org/library/pickle.html#what-can-be-pickled-and-unpickled">pickleable</a>.
The exceptions thrown while using <tt class="docutils literal"><span class="pre">multiprocessing</span></tt> can be quite cryptic
and even though we&#8217;ve tried to make this feature as user-friendly as possible,
it can sometimes cause some headaches. One useful debugging tactic is to
try running with 1 thread if your processes start to crash. This will
generally provide much more illuminating error messages than in the parallel
case.</p>
<p>It is also important to note that the <tt class="docutils literal"><span class="pre">multiprocessing</span></tt> module works by
spawning a large number of new <tt class="docutils literal"><span class="pre">python</span></tt> processes and running the code in
isolation within those processes. This means that there is a significant
amount of overhead involved at each step of the parallelization process.
With this in mind, it is not surprising that running a simple problem like
the <a class="reference internal" href="../quickstart/#quickstart"><em>quickstart example</em></a> in parallel will run much slower
than the equivalent serial code. If your log-probability function takes
a significant amount of time (&gt; 1 second or so) to compute then using the
parallel sampler actually provides significant speed gains.</p>
</div>
<div class="section" id="arbitrary-metadata-blobs">
<span id="blobs"></span><h2>Arbitrary metadata blobs<a class="headerlink" href="#arbitrary-metadata-blobs" title="Permalink to this headline">¶</a></h2>
<p><em>(New in version 1.1.0)</em></p>
<p>Imagine that your log-probability function involves an extremely
computationally expensive numerical simulation starting from initial
conditions parameterized by the position of the walker in parameter space.
Then you have to compare the results of your simulation by projecting into
data space (predicting you data) and computing something like a chi-squared
scalar in this space. After you run MCMC, you might want to visualize
the draws from your probability function in data space by over-plotting
samples on your data points. It is obviously unreasonable to recompute
all the simulations for all the initial conditions that you want to display
as a part of your post-processing—especially since you already computed all
of them before! Instead, it would be ideal to be able to store realizations
associated with each step in the MCMC and then just display those after the
fact. This is possible using the &#8220;arbitrary blob&#8221; pattern.</p>
<p>To use <tt class="docutils literal"><span class="pre">blobs</span></tt>, you just need to modify your log-probability function to
return a second argument (this can be any arbitrary Python object). Then,
the sampler object will have an attribute (called
<a class="reference internal" href="../../api/#emcee.EnsembleSampler.blobs" title="emcee.EnsembleSampler.blobs"><tt class="xref py py-attr docutils literal"><span class="pre">EnsembleSampler.blobs</span></tt></a>) that is a list (of length <tt class="docutils literal"><span class="pre">niterations</span></tt>)
of lists (of length <tt class="docutils literal"><span class="pre">nwalkers</span></tt>) containing all the accepted <tt class="docutils literal"><span class="pre">blobs</span></tt>
associated with the walker positions in <a class="reference internal" href="../../api/#emcee.EnsembleSampler.chain" title="emcee.EnsembleSampler.chain"><tt class="xref py py-attr docutils literal"><span class="pre">EnsembleSampler.chain</span></tt></a>.</p>
<p>As an absolutely trivial example, let&#8217;s say that we wanted to store the
sum of cubes of the input parameters as a string at each position in the
chain. To do this we could simply sample a function like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">lnprobfn</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
<p>It is important to note that by returning two values from our log-probability
function, we also change the output of <a class="reference internal" href="../../api/#emcee.EnsembleSampler.sample" title="emcee.EnsembleSampler.sample"><tt class="xref py py-func docutils literal"><span class="pre">EnsembleSampler.sample()</span></tt></a> and
<a class="reference internal" href="../../api/#emcee.EnsembleSampler.run_mcmc" title="emcee.EnsembleSampler.run_mcmc"><tt class="xref py py-func docutils literal"><span class="pre">EnsembleSampler.run_mcmc()</span></tt></a> to return 4 values (position, probability,
random number generator state and blobs) instead of just the first three.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><p class="logo">
    <a href="../../">
        <img class="logo" src="../../_static/logo-sidebar.png" alt="Logo"/>
    </a>
</p>

<p>
    emcee is an extensible, pure-Python implementation of
    Goodman &amp; Weare's
    <a href="http://msp.berkeley.edu/camcos/2010/5-1/p04.xhtml">Affine
        Invariant Markov chain Monte Carlo (MCMC) Ensemble sampler</a>.
    It's designed for Bayesian parameter estimation and it's really sweet!
</p>
  <h3><a href="../../">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Advanced Patterns</a><ul>
<li><a class="reference internal" href="#incrementally-saving-progress">Incrementally saving progress</a></li>
<li><a class="reference internal" href="#multiprocessing">Multiprocessing</a></li>
<li><a class="reference internal" href="#arbitrary-metadata-blobs">Arbitrary metadata blobs</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../../">Documentation overview</a><ul>
      <li>Previous: <a href="../quickstart/" title="previous chapter">Quickstart</a></li>
      <li>Next: <a href="../faq/" title="next chapter">FAQ</a></li>
  </ul></li>
</ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
      &copy; Copyright 2012, Dan Foreman-Mackey.
    </div>
    <a href="https://github.com/dfm/emcee" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;"
            src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
            alt="Fork me on GitHub"  class="github"/>
    </a>

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-22909046-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
    </script>
  </body>
</html>